<!doctype html>

<html lang="en" class="light-style layout-menu-fixed layout-compact" dir="ltr" data-theme="theme-default"
  data-assets-path="../assets/" data-template="vertical-menu-template-free" data-style="light">

<head>
  <meta charset="utf-8" />
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0" />

  <title>WA Wot - By Abhinavelaveni</title>

  <meta name="description" content="" />

  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="../assets/img/favicon/favicon.ico" />
  <!-- Tabler Icons CSS -->
  <link href="https://cdn.jsdelivr.net/npm/@tabler/icons@latest/iconfont/tabler-icons.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">


  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Public+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,500;1,600;1,700&display=swap"
    rel="stylesheet" />

  <link rel="stylesheet" href="../assets/vendor/fonts/boxicons.css" />

  <!-- Core CSS -->
  <link rel="stylesheet" href="../assets/vendor/css/core.css" class="template-customizer-core-css" />
  <link rel="stylesheet" href="../assets/vendor/css/theme-default.css" class="template-customizer-theme-css" />
  <link rel="stylesheet" href="../assets/css/demo.css" />

  <!-- Vendors CSS -->
  <link rel="stylesheet" href="../assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.css" />
  <link rel="stylesheet" href="../assets/vendor/libs/apex-charts/apex-charts.css" />

  <!-- Page CSS -->

  <!-- Helpers -->
  <script src="../assets/vendor/js/helpers.js"></script>
  <script src="../assets/vendor/js/myjavascript.js"></script>
  <!--! Template customizer & Theme config files MUST be included after core stylesheets and helpers.js in the <head> section -->
  <script src="../assets/vendor/js/template-customizer.js"></script>
  <!--? Config:  Mandatory theme config file contain global vars & default theme options, Set your preferred theme option in this file.  -->
  <script src="../assets/js/config.js"></script>
</head>

<body>
  <!-- Layout wrapper -->
  <div class="layout-wrapper layout-content-navbar">
    <div class="layout-container">
      <!-- Menu -->

      <aside id="layout-menu" class="layout-menu menu-vertical menu bg-menu-theme">
        <div class="app-brand demo">
          <a href="index.html" class="app-brand-link">
            <span class="app-brand-logo demo">

            </span>
            <span class="app-brand-text demo menu-text fw-bold ms-2">ABHI Bot</span>
          </a>

          <a href="javascript:void(0);" class="layout-menu-toggle menu-link text-large ms-auto d-block d-xl-none">
            <i class="bx bx-chevron-left bx-sm d-flex align-items-center justify-content-center"></i>
          </a>
        </div>

        <div class="menu-inner-shadow"></div>

        <ul class="menu-inner py-1">
          <!-- Dashboards -->
          <li class="menu-item active open">
            <a href="javascript:void(0);" class="menu-link d-flex align-items-center">
              <i class="menu-icon tf-icons bx bx-home-smile me-2"></i>
              <div class="text-truncate" data-i18n="Dashboards">Dashboards</div>
              <!-- <span class="badge rounded-pill bg-danger ms-auto" id="online-devices-count">0</span> -->
            </a>
          </li>
          <li>
            <section id="client-selection-section" class="container mt-4" style="max-width: 500px;">
              <label for="client-select" class="form-label"><strong>Connected Clients:</strong></label>
              <select id="client-select" class="form-select main-device" style="cursor: pointer; width: 100%;">
                <option value="">Select Device</option>
              </select>
              <div id="status-message" class="mt-2 small"></div>
              <div id="selected-client-info" class="card mt-2 shadow-sm" style="display:none;">
                <div class="card-body p-3 rounded-3 bg-white">
                  <h6 class="card-title mb-3 text-primary small fw-semibold">
                    <i class="bi bi-phone me-1"></i> Selected Device Info
                  </h6>
                  <div class="row mb-2 align-items-center">
                    <div class="col-5 text-muted small text-end">Name:</div>
                    <div class="col-7 small"><span id="selected-client-name" class="text-secondary"></span></div>
                  </div>
                  <div class="row mb-2 align-items-center">
                    <div class="col-5 text-muted small text-end">Status:</div>
                    <div class="col-7 small">
                      <span id="selected-client-status" class="text-secondary"></span>
                    </div>
                  </div>
                  <div class="row mb-2 align-items-center">
                    <div class="col-5 text-muted small text-end">Last Activity:</div>
                    <div class="col-7 small"><span id="selected-client-last-activity" class="text-secondary"></span>
                    </div>
                  </div>
                  <div class="row mb-1 align-items-center">
                    <div class="col-5 text-muted small text-end">Session Age:</div>
                    <div class="col-7 small"><span id="selected-client-session-age" class="text-secondary"></span></div>
                  </div>
                </div>
              </div>

              <script defer>
                const API_BASE = 'http://localhost:3000/api';

                const clientSelect = document.getElementById('client-select');
                const statusMessage = document.getElementById('status-message');

                const selectedClientInfoDiv = document.getElementById('selected-client-info');
                const selectedClientName = document.getElementById('selected-client-name');
                const selectedClientStatus = document.getElementById('selected-client-status');
                const selectedClientLastActivity = document.getElementById('selected-client-last-activity');
                const selectedClientSessionAge = document.getElementById('selected-client-session-age');

                // Utility for safe JSON fetching
                async function fetchJson(url, options = {}) {
                  const resp = await fetch(url, options);
                  const contentType = resp.headers.get('content-type') || '';
                  if (!contentType.includes('application/json')) {
                    const text = await resp.text();
                    throw new Error(`Expected JSON but got: ${text.substring(0, 200)}`);
                  }
                  if (!resp.ok) {
                    const errData = await resp.json().catch(() => ({}));
                    throw new Error(errData.error || resp.statusText || 'Unknown error');
                  }
                  return resp.json();
                }

                // Load connected clients into dropdown
                async function loadConnectedClients() {
                  try {
                    const data = await fetchJson(`${API_BASE}/clients/connected`);
                    clientSelect.innerHTML = '<option value="">Select Device</option>';
                    if (data.clients.length === 0) {
                      clientSelect.innerHTML = '<option value="">No connected clients available</option>';
                      clientSelect.disabled = true;
                    } else {
                      data.clients.forEach(client => {
                        const option = document.createElement('option');
                        option.value = client.name;
                        option.textContent = `${client.name} `;;
                        clientSelect.appendChild(option);
                      });
                      clientSelect.disabled = false;
                    }
                    setStatus(`Loaded ${data.clients.length} connected client(s)`);
                  } catch (err) {
                    clientSelect.innerHTML = '<option value="">Error loading clients</option>';
                    clientSelect.disabled = true;
                    setStatus(`Error loading clients: ${err.message}`);
                  }
                }

                // Load current selected client info
                async function loadSelectedClient() {
                  try {
                    const data = await fetchJson(`${API_BASE}/selected-device`);
                    if (!data.selectedDevice) {
                      selectedClientInfoDiv.style.display = 'none';
                      setStatus('No device currently selected.');
                      clientSelect.value = ""; // Reset dropdown selection
                    } else {
                      selectedClientInfoDiv.style.display = 'block';
                      selectedClientName.textContent = data.selectedDevice;
                      selectedClientStatus.textContent = data.status || 'N/A';
                      selectedClientLastActivity.textContent = data.lastActivity ? new Date(data.lastActivity).toLocaleString() : 'N/A';
                      selectedClientSessionAge.textContent = data.sessionAge || 'N/A';
                      setStatus(`Selected client: ${data.selectedDevice}`);
                      clientSelect.value = data.selectedDevice;
                    }
                  } catch (err) {
                    selectedClientInfoDiv.style.display = 'none';
                    setStatus(`Error fetching selected client: ${err.message}`);
                  }
                }

                // Select a client dynamically
                async function selectClient(clientName) {
                  if (!clientName) return;
                  try {
                    await fetchJson(`${API_BASE}/select-device`, {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify({ deviceName: clientName }),
                    });
                    setStatus(`Selected client: ${clientName}`);
                  } catch (err) {
                    setStatus(`Error selecting client: ${err.message}`);
                  }
                }

                // Clear selected client dynamically
                async function clearSelectedClient() {
                  try {
                    const data = await fetchJson(`${API_BASE}/clear-selected-device`, {
                      method: 'POST',
                    });
                    setStatus(data.message || 'Selection cleared.');
                  } catch (err) {
                    setStatus(`Error clearing selection: ${err.message}`);
                  }
                }

                function setStatus(msg) {
                  statusMessage.textContent = msg;
                }

                // Event listener for client selection changes
                clientSelect.addEventListener('change', async () => {
                  const selectedValue = clientSelect.value;
                  if (selectedValue) {
                    await selectClient(selectedValue);
                  } else {
                    await clearSelectedClient();
                  }
                  await loadSelectedClient();
                });

                // Initialize UI on page load
                loadConnectedClients();
                loadSelectedClient();

                // Refresh every 60 seconds
                setInterval(loadConnectedClients, 60000);
                setInterval(loadSelectedClient, 60000);
              </script>

          </li>
          <!-- WhatsApp Features -->
          <li class="menu-header small text-uppercase">
            <span class="menu-header-text">WhatsApp Features</span>
          </li>
          <li class="menu-item">
            <a href="javascript:void(0);" class="menu-link menu-toggle">
              <i class="menu-icon tf-icons bx bx-cube-alt"></i>
              <div class="text-truncate" data-i18n="">Auto-Features</div>
            </a>
            <ul class="menu-sub">
              <li class="menu-item">
                <a href="singlemessenger.html" class="menu-link">
                  <div class="text-truncate" data-i18n="#">Single Messenger</div>
                </a>
              </li>
              <li class="menu-item">
                <a href="bulkmessaging.html" class="menu-link">
                  <div class="text-truncate" data-i18n="#">Bulk Message</div>
                </a>
              </li>
              <li class="menu-item">
                <a href="greetingmessage.html" class="menu-link">
                  <div class="text-truncate" data-i18n="#">Greeting Message</div>
                </a>
              </li>
            </ul>
          </li>
          <li class="menu-item">
            <a href="auto-responder.html" class="menu-link">
              <i class="menu-icon ti ti-brand-gravatar"></i>
              <div class="text-truncate" data-i18n="">Auto-Responder</div>
            </a>
          </li>
          <li class="menu-item">
            <a href="filemanager.html" class="menu-link">
              <i class="menu-icon ti ti-file-dots"></i>
              <div class="text-truncate" data-i18n="">File-Manager</div>
            </a>
          </li>
          <li class="menu-item">
            <a href="#" class="menu-link">
              <i class="menu-icon ti ti-brand-whatsapp"></i>
              <div class="text-truncate" data-i18n="">Sender-Logs</div>
            </a>
          </li>

          <!-- College Features -->
          <li class="menu-header small text-uppercase">
            <span class="menu-header-text">College Features</span>
          </li>
          <li class="menu-item">
            <a href="javascript:void(0);" class="menu-link menu-toggle">
              <i class="menu-icon ti ti-bell-ringing"></i>
              <div class="text-truncate" data-i18n="">Auto Notifier</div>
            </a>
            <ul class="menu-sub">
              <li class="menu-item">
                <a href="auto-responder.html" class="menu-link">
                  <div class="text-truncate" data-i18n="#">Fee Reminders</div>
                </a>
              </li>
              <li class="menu-item">
                <a href="auto-responder.html" class="menu-link">
                  <div class="text-truncate" data-i18n="#">Attendance Alerts</div>
                </a>
              </li>
              <li class="menu-item">
                <a href="auto-responder.html" class="menu-link">
                  <div class="text-truncate" data-i18n="#">Student Performance</div>
                </a>
              </li>
            </ul>
          </li>
          <!-- Dept Performance -->
          <li class="menu-item">
            <a href="javascript:void(0);" class="menu-link menu-toggle">
              <i class="menu-icon ti ti-brand-office"></i>
              <div class="text-truncate" data-i18n="">Dept Performance</div>
            </a>
            <ul class="menu-sub">
              <li class="menu-item">
                <a href="auto-responder.html" class="menu-link">
                  <div class="text-truncate" data-i18n="#">HODs</div>
                </a>
              </li>
              <li class="menu-item">
                <a href="auto-responder.html" class="menu-link">
                  <div class="text-truncate" data-i18n="#">Staff</div>
                </a>
              </li>
            </ul>
          </li>
          <!-- HODS Section -->
          <li class="menu-item">
            <a href="javascript:void(0);" class="menu-link menu-toggle">
              <i class="menu-icon fa-solid fa-user-tie"></i>
              <div class="text-truncate" data-i18n="">HOD Central</div>
            </a>
            <ul class="menu-sub">
              <li class="menu-item">
                <a href="auto-responder.html" class="menu-link">
                  <div class="text-truncate" data-i18n="#">Announcements</div>
                </a>
              </li>
              <li class="menu-item">
                <a href="auto-responder.html" class="menu-link">
                  <div class="text-truncate" data-i18n="#">Academic and Exam Management</div>
                </a>
              </li>
            </ul>
          </li>
          <li class="menu-item">
            <a href="#" class="menu-link">
              <i class="menu-icon fa-solid fa-calendar-days"></i>
              <div class="text-truncate" data-i18n="">Events</div>
            </a>
          </li>
          <li class="menu-item">
            <a href="#" class="menu-link">
              <i class="menu-icon ti ti-message-circle"></i>
              <div class="text-truncate" data-i18n="">Quick Replies</div>
            </a>
          </li>
          <li class="menu-item">
            <a href="#" class="menu-link">
              <i class="menu-icon ti ti-brand-whatsapp"></i>
              <div class="text-truncate" data-i18n="">Sender-Logs</div>
            </a>
          </li>


          <li class="menu-header small text-uppercase">
            <span class="menu-header-text">Main &amp; Menu</span>
          </li>
          <li class="menu-item">
            <a href="javascript:void(0);" class="menu-link menu-toggle">
              <i class="menu-icon tf-icons bx bx-dock-top"></i>
              <div class="text-truncate" data-i18n="Account Settings">Account Settings</div>
            </a>
            <ul class="menu-sub">
              <li class="menu-item">
                <a href="pages-account-settings-account.html" class="menu-link">
                  <div class="text-truncate" data-i18n="Account">Account</div>
                </a>
              </li>
              <li class="menu-item">
                <a href="pages-account-settings-notifications.html" class="menu-link">
                  <div class="text-truncate" data-i18n="Notifications">Notifications</div>
                </a>
              </li>
              <li class="menu-item">
                <a href="pages-account-settings-connections.html" class="menu-link">
                  <div class="text-truncate" data-i18n="Connections">Connections</div>
                </a>
              </li>
            </ul>
          </li>
          <li class="menu-item">
            <a href="javascript:void(0);" class="menu-link menu-toggle">
              <i class="menu-icon tf-icons bx bx-lock-open-alt"></i>
              <div class="text-truncate" data-i18n="Authentications">Authentications</div>
            </a>
            <ul class="menu-sub">
              <li class="menu-item">
                <a href="auth-login-basic.html" class="menu-link" target="_blank">
                  <div class="text-truncate" data-i18n="Basic">Login</div>
                </a>
              </li>
              <li class="menu-item">
                <a href="auth-register-basic.html" class="menu-link" target="_blank">
                  <div class="text-truncate" data-i18n="Basic">Register</div>
                </a>
              </li>
              <li class="menu-item">
                <a href="auth-forgot-password-basic.html" class="menu-link" target="_blank">
                  <div class="text-truncate" data-i18n="Basic">Forgot Password</div>
                </a>
              </li>
            </ul>
          </li>
          <li class="menu-item">
            <a href="javascript:void(0);" class="menu-link menu-toggle">
              <i class="menu-icon tf-icons bx bx-cube-alt"></i>
              <div class="text-truncate" data-i18n="Misc">Misc</div>
            </a>
            <ul class="menu-sub">
              <li class="menu-item">
                <a href="pages-misc-error.html" class="menu-link">
                  <div class="text-truncate" data-i18n="Error">Error</div>
                </a>
              </li>
              <li class="menu-item">
                <a href="pages-misc-under-maintenance.html" class="menu-link">
                  <div class="text-truncate" data-i18n="Under Maintenance">Under Maintenance</div>
                </a>
              </li>
            </ul>
          </li>
          <!-- Components -->
          <li class="menu-header small text-uppercase"><span class="menu-header-text">Components</span></li>
          <!-- Cards -->
          <li class="menu-item">
            <a href="cards-basic.html" class="menu-link">
              <i class="menu-icon tf-icons bx bx-collection"></i>
              <div class="text-truncate" data-i18n="Basic">Cards</div>
            </a>
          </li>
          <!-- User interface -->
          <li class="menu-item">
            <a href="javascript:void(0)" class="menu-link menu-toggle">
              <i class="menu-icon tf-icons bx bx-box"></i>
              <div class="text-truncate" data-i18n="User interface">User interface</div>
            </a>
            <ul class="menu-sub">
              <li class="menu-item">
                <a href="ui-accordion.html" class="menu-link">
                  <div class="text-truncate" data-i18n="Accordion">Accordion</div>
                </a>
              </li>
              <li class="menu-item">
                <a href="ui-alerts.html" class="menu-link">
                  <div class="text-truncate" data-i18n="Alerts">Alerts</div>
                </a>
              </li>
              <li class="menu-item">
                <a href="ui-badges.html" class="menu-link">
                  <div class="text-truncate" data-i18n="Badges">Badges</div>
                </a>
              </li>
              <li class="menu-item">
                <a href="ui-buttons.html" class="menu-link">
                  <div class="text-truncate" data-i18n="Buttons">Buttons</div>
                </a>
              </li>
              <li class="menu-item">
                <a href="ui-carousel.html" class="menu-link">
                  <div class="text-truncate" data-i18n="Carousel">Carousel</div>
                </a>
              </li>
              <li class="menu-item">
                <a href="ui-collapse.html" class="menu-link">
                  <div class="text-truncate" data-i18n="Collapse">Collapse</div>
                </a>
              </li>
              <li class="menu-item">
                <a href="ui-dropdowns.html" class="menu-link">
                  <div class="text-truncate" data-i18n="Dropdowns">Dropdowns</div>
                </a>
              </li>
              <li class="menu-item">
                <a href="ui-footer.html" class="menu-link">
                  <div class="text-truncate" data-i18n="Footer">Footer</div>
                </a>
              </li>
              <li class="menu-item">
                <a href="ui-list-groups.html" class="menu-link">
                  <div class="text-truncate" data-i18n="List Groups">List groups</div>
                </a>
              </li>
              <li class="menu-item">
                <a href="ui-modals.html" class="menu-link">
                  <div class="text-truncate" data-i18n="Modals">Modals</div>
                </a>
              </li>
              <li class="menu-item">
                <a href="ui-navbar.html" class="menu-link">
                  <div class="text-truncate" data-i18n="Navbar">Navbar</div>
                </a>
              </li>
              <li class="menu-item">
                <a href="ui-offcanvas.html" class="menu-link">
                  <div class="text-truncate" data-i18n="Offcanvas">Offcanvas</div>
                </a>
              </li>
              <li class="menu-item">
                <a href="ui-pagination-breadcrumbs.html" class="menu-link">
                  <div class="text-truncate" data-i18n="Pagination & Breadcrumbs">Pagination &amp; Breadcrumbs</div>
                </a>
              </li>
              <li class="menu-item">
                <a href="ui-progress.html" class="menu-link">
                  <div class="text-truncate" data-i18n="Progress">Progress</div>
                </a>
              </li>
              <li class="menu-item">
                <a href="ui-spinners.html" class="menu-link">
                  <div class="text-truncate" data-i18n="Spinners">Spinners</div>
                </a>
              </li>
              <li class="menu-item">
                <a href="ui-tabs-pills.html" class="menu-link">
                  <div class="text-truncate" data-i18n="Tabs & Pills">Tabs &amp; Pills</div>
                </a>
              </li>
              <li class="menu-item">
                <a href="ui-toasts.html" class="menu-link">
                  <div class="text-truncate" data-i18n="Toasts">Toasts</div>
                </a>
              </li>
              <li class="menu-item">
                <a href="ui-tooltips-popovers.html" class="menu-link">
                  <div class="text-truncate" data-i18n="Tooltips & Popovers">Tooltips &amp; Popovers</div>
                </a>
              </li>
              <li class="menu-item">
                <a href="ui-typography.html" class="menu-link">
                  <div class="text-truncate" data-i18n="Typography">Typography</div>
                </a>
              </li>
            </ul>
          </li>

          <!-- Extended components -->
          <li class="menu-item">
            <a href="javascript:void(0)" class="menu-link menu-toggle">
              <i class="menu-icon tf-icons bx bx-copy"></i>
              <div class="text-truncate" data-i18n="Extended UI">Extended UI</div>
            </a>
            <ul class="menu-sub">
              <li class="menu-item">
                <a href="extended-ui-perfect-scrollbar.html" class="menu-link">
                  <div class="text-truncate" data-i18n="Perfect Scrollbar">Perfect Scrollbar</div>
                </a>
              </li>
              <li class="menu-item">
                <a href="extended-ui-text-divider.html" class="menu-link">
                  <div class="text-truncate" data-i18n="Text Divider">Text Divider</div>
                </a>
              </li>
            </ul>
          </li>

          <li class="menu-item">
            <a href="icons-boxicons.html" class="menu-link">
              <i class="menu-icon tf-icons bx bx-crown"></i>
              <div class="text-truncate" data-i18n="Boxicons">Boxicons</div>
            </a>
          </li>

          <!-- Forms & Tables -->
          <li class="menu-header small text-uppercase"><span class="menu-header-text">Forms &amp; Tables</span></li>
          <!-- Forms -->
          <li class="menu-item">
            <a href="javascript:void(0);" class="menu-link menu-toggle">
              <i class="menu-icon tf-icons bx bx-detail"></i>
              <div class="text-truncate" data-i18n="Form Elements">Form Elements</div>
            </a>
            <ul class="menu-sub">
              <li class="menu-item">
                <a href="forms-basic-inputs.html" class="menu-link">
                  <div class="text-truncate" data-i18n="Basic Inputs">Basic Inputs</div>
                </a>
              </li>
              <li class="menu-item">
                <a href="forms-input-groups.html" class="menu-link">
                  <div class="text-truncate" data-i18n="Input groups">Input groups</div>
                </a>
              </li>
            </ul>
          </li>
          <li class="menu-item">
            <a href="javascript:void(0);" class="menu-link menu-toggle">
              <i class="menu-icon tf-icons bx bx-detail"></i>
              <div class="text-truncate" data-i18n="Form Layouts">Form Layouts</div>
            </a>
            <ul class="menu-sub">
              <li class="menu-item">
                <a href="form-layouts-vertical.html" class="menu-link">
                  <div class="text-truncate" data-i18n="Vertical Form">Vertical Form</div>
                </a>
              </li>
              <li class="menu-item">
                <a href="form-layouts-horizontal.html" class="menu-link">
                  <div class="text-truncate" data-i18n="Horizontal Form">Horizontal Form</div>
                </a>
              </li>
            </ul>
          </li>
          <!-- Tables -->
          <li class="menu-item">
            <a href="tables-basic.html" class="menu-link">
              <i class="menu-icon tf-icons bx bx-table"></i>
              <div class="text-truncate" data-i18n="Tables">Tables</div>
            </a>
          </li>
          <!-- Misc -->
          <li class="menu-header small text-uppercase"><span class="menu-header-text">Misc</span></li>
          <li class="menu-item">
            <a href="https://github.com/themeselection/sneat-html-admin-template-free/issues" target="_blank"
              class="menu-link">
              <i class="menu-icon tf-icons bx bx-support"></i>
              <div class="text-truncate" data-i18n="Support">Support</div>
            </a>
          </li>
          <li class="menu-item">
            <a href="https://demos.themeselection.com/sneat-bootstrap-html-admin-template/documentation/"
              target="_blank" class="menu-link">
              <i class="menu-icon tf-icons bx bx-file"></i>
              <div class="text-truncate" data-i18n="Documentation">Documentation</div>
            </a>
          </li>
        </ul>
      </aside>
      <!-- / Menu -->

      <!-- Layout container -->
      <div class="layout-page">
        <!-- Navbar -->

        <nav
          class="layout-navbar container-xxl navbar navbar-expand-xl navbar-detached align-items-center bg-navbar-theme"
          id="layout-navbar">
          <div class="layout-menu-toggle navbar-nav align-items-xl-center me-4 me-xl-0 d-xl-none">
            <a class="nav-item nav-link px-0 me-xl-6" href="javascript:void(0)">
              <i class="bx bx-menu bx-md"></i>
            </a>
          </div>

          <div class="navbar-nav-right d-flex align-items-center" id="navbar-collapse">
            <!-- Server Health Status in Navbar -->
            <div class="navbar-nav align-items-center">
              <div class="nav-item d-flex align-items-center">
              <span id="status-dot" class="rounded-circle me-2"
                style="width:10px;height:10px;background-color:gray;display:inline-block;"></span>
              <span id="nav-status" class="badge bg-secondary me-2">Loading...</span>
              <span id="nav-uptime" class="text-muted small me-3">0s</span>
              <span id="nav-memory" class="text-muted small">0 MB</span>
              </div>
            </div>

            <script>
              async function fetchNavHealth() {
              try {
                const res = await fetch('/api/health');
                const data = await res.json();

                // Status Badge + Dot
                const navStatus = document.getElementById('nav-status');
                const statusDot = document.getElementById('status-dot');

                if (data.status === 'ok') {
                navStatus.textContent = 'Connected';
                navStatus.className = 'badge bg-success me-2';
                statusDot.style.backgroundColor = 'limegreen';
                } else {
                navStatus.textContent = 'Disconnected';
                navStatus.className = 'badge bg-danger me-2';
                statusDot.style.backgroundColor = 'red';
                }

                // Uptime (HH:MM:SS)
                const uptimeSec = Math.floor(data.uptime);
                const hours = Math.floor(uptimeSec / 3600);
                const minutes = Math.floor((uptimeSec % 3600) / 60);
                const seconds = uptimeSec % 60;
                document.getElementById('nav-uptime').textContent = `${hours}h ${minutes}m ${seconds}s`;

                // Memory Usage (MB)
                const memMB = (data.memoryUsage.rss / 1024 / 1024).toFixed(1);
                document.getElementById('nav-memory').textContent = `${memMB} MB`;

              } catch (err) {
                console.error('Navbar Health Fetch Failed:', err);
                document.getElementById('nav-status').textContent = 'Disconnected';
                document.getElementById('nav-status').className = 'badge bg-danger me-2';
                document.getElementById('status-dot').style.backgroundColor = 'red';
              }
              }

              fetchNavHealth();
                // Call immediately, then esvery 2 seconds for real-time updates
                fetchNavHealth();
                setInterval(fetchNavHealth, 1000);
            </script>


            <ul class="navbar-nav flex-row align-items-center ms-auto">
              <!-- Place this tag where you want the button to render. -->
              <li class="nav-item lh-1 me-4">
                <a class="github-button" href="https://github.com/themeselection/sneat-html-admin-template-free"
                  data-icon="octicon-star" data-size="large" data-show-count="true"
                  aria-label="Star themeselection/sneat-html-admin-template-free on GitHub">Star</a>
              </li>

              <!-- User -->
              <li class="nav-item navbar-dropdown dropdown-user dropdown">
                <a class="nav-link dropdown-toggle hide-arrow p-0" href="javascript:void(0);" data-bs-toggle="dropdown">
                  <div class="avatar avatar-online">
                    <img src="../assets/img/avatars/1.png" alt class="w-px-40 h-auto rounded-circle" />
                  </div>
                </a>
                <ul class="dropdown-menu dropdown-menu-end">
                  <li>
                    <a class="dropdown-item" href="#">
                      <div class="d-flex">
                        <div class="flex-shrink-0 me-3">
                          <div class="avatar avatar-online">
                            <img src="../assets/img/avatars/1.png" alt class="w-px-40 h-auto rounded-circle" />
                          </div>
                        </div>
                        <div class="flex-grow-1">
                          <h6 class="mb-0">John Doe</h6>
                          <small class="text-muted">Admin</small>
                        </div>
                      </div>
                    </a>
                  </li>
                  <li>
                    <div class="dropdown-divider my-1"></div>
                  </li>
                  <li>
                    <a class="dropdown-item" href="#">
                      <i class="bx bx-user bx-md me-3"></i><span>My Profile</span>
                    </a>
                  </li>
                  <li>
                    <a class="dropdown-item" href="#"> <i class="bx bx-cog bx-md me-3"></i><span>Settings</span> </a>
                  </li>
                  <li>
                    <a class="dropdown-item" href="#">
                      <span class="d-flex align-items-center align-middle">
                        <i class="flex-shrink-0 bx bx-credit-card bx-md me-3"></i><span
                          class="flex-grow-1 align-middle">Billing Plan</span>
                        <span class="flex-shrink-0 badge rounded-pill bg-danger">4</span>
                      </span>
                    </a>
                  </li>
                  <li>
                    <div class="dropdown-divider my-1"></div>
                  </li>
                  <li>
                    <a class="dropdown-item" href="javascript:void(0);">
                      <i class="bx bx-power-off bx-md me-3"></i><span>Log Out</span>
                    </a>
                  </li>
                </ul>
              </li>
              <!--/ User -->
            </ul>
          </div>
        </nav>
        <!-- / Navbar -->

        <div class="wrapper">
          <!-- Content wrapper -->
          <div class="content-wrapper">
            <div class="container-xxl flex-grow-1 container-p-y">
              <!-- Stats Cards Row -->
              <div class="row mb-4">
                <!-- Active Devices Card -->
                <div class="col-md-4">
                  <div class="card">
                    <div class="card-body">
                      <div class="d-flex justify-content-between align-items-center">
                        <div>
                          <h5 class="card-title text-primary mb-2">Active Devices</h5>
                          <h2 class="mb-0" id="online-devices-count">0</h2>
                          <small class="text-muted">devices that are online</small>
                        </div>
                        <div class="avatar">
                          <div class="avatar-initial bg-label-primary rounded-circle">
                            <i class="bi bi-phone fs-4"></i>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Total Devices Card -->
                <div class="col-md-4">
                  <div class="card">
                    <div class="card-body">
                      <div class="d-flex justify-content-between align-items-center">
                        <div>
                          <h5 class="card-title text-success mb-2">Total Devices</h5>
                          <h2 class="mb-0" id="total-devices-count">0</h2>
                          <small class="text-muted">registered in system</small>
                        </div>
                        <div class="avatar">
                          <div class="avatar-initial bg-label-success rounded-circle">
                            <i class="bi bi-collection fs-4"></i>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Recent Activity Card -->
                <div class="col-md-4">
                  <div class="card">
                    <div class="card-body">
                      <div class="d-flex justify-content-between align-items-center">
                        <div>
                          <h5 class="card-title text-info mb-2">Recent Activity</h5>
                          <p class="mb-0" id="recent-activity">No recent activity</p>
                          <small class="text-muted">last 5 minutes</small>
                        </div>
                        <div class="avatar">
                          <div class="avatar-initial bg-label-info rounded-circle">
                            <i class="bi bi-activity fs-4"></i>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Main Content Row -->
              <div class="row">
                <div class="col-xxl-8">
                  <!-- Clients Table Card -->
                  <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                      <h5 class="mb-0">Device Management</h5>
                      <div>
                        <button id="refreshClientsBtn" class="btn btn-sm btn-outline-secondary me-2" title="Refresh">
                          <i class="bi bi-arrow-clockwise"></i>
                        </button>
                        <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal"
                          data-bs-target="#addDeviceModal">
                          <i class="bi bi-plus-circle me-1"></i> Add Device
                        </button>
                      </div>
                    </div>
                    <div class="card-body">
                      <div class="table-responsive">
                        <table class="table table-hover" id="clientsTable">
                          <thead>
                            <tr>
                              <th>Device Name</th>
                              <th>Phone Number</th>
                              <th>Status</th>
                              <th>Last Active</th>
                              <th>Actions</th>
                            </tr>
                          </thead>
                          <tbody id="clientsTableBody">
                            <tr>
                              <td colspan="5" class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                  <span class="visually-hidden">Loading...</span>
                                </div>
                              </td>
                            </tr>
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="col-xxl-4">
                  <!-- QR Code Section -->
                  <div class="card mb-4" id="qrSection" style="display: none;">
                    <div class="card-header d-flex justify-content-between align-items-center">
                      <h5 class="mb-0">Device Authentication</h5>
                      <span id="currentClientName" class="badge bg-primary"></span>
                    </div>
                    <div class="card-body text-center">
                      <div class="qr-container mb-3" id="qrPlaceholder">
                        <div class="spinner-border text-primary" role="status">
                          <span class="visually-hidden">Loading...</span>
                        </div>
                      </div>
                      <img id="qrImage" style="display: none; width: 250px; height: 250px; margin: 0 auto;">

                      <div id="clientStatus" class="mb-3">
                        <div class="alert alert-info mb-0">
                          <i class="bi bi-info-circle me-2"></i> Preparing QR code for authentication...
                        </div>
                      </div>

                      <div class="d-grid gap-2">
                        <button id="logoutBtn" class="btn btn-danger" style="display: none;">
                          <i class="bi bi-box-arrow-left me-1"></i> Logout Device
                        </button>
                        <button id="copyQrBtn" class="btn btn-outline-secondary" style="display: none;">
                          <i class="bi bi-clipboard me-1"></i> Copy QR Code
                        </button>
                      </div>
                    </div>
                  </div>

                  <!-- Recent Logs Card -->
                  <div class="card">
                    <div class="card-header">
                      <h5 class="mb-0">Recent Activity Logs</h5>
                    </div>
                    <div class="card-body p-0">
                      <div class="table-responsive">
                        <table class="table table-borderless mb-0">
                          <tbody id="recentLogsBody">
                            <tr>
                              <td class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                  <span class="visually-hidden">Loading...</span>
                                </div>
                              </td>
                            </tr>
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Add Device Modal -->
          <div class="modal fade" id="addDeviceModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">Add New Device</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="addDeviceForm" novalidate>
                  <div class="modal-body">
                    <div class="mb-3">
                      <label for="deviceName" class="form-label">Device Name</label>
                      <input type="text" class="form-control" id="deviceName" required
                        placeholder="e.g., Office WhatsApp">
                      <div class="invalid-feedback">Please provide a device name (3-30 characters).</div>
                    </div>
                    <div class="mb-3">
                      <label for="deviceNumber" class="form-label">Phone Number</label>
                      <div class="input-group">
                        <select class="form-select" id="countryCode" style="max-width: 120px;">
                          <option value="91">IN (+91)</option>
                          <option value="1">US (+1)</option>
                          <option value="44">UK (+44)</option>
                          <option value="62">ID (+62)</option>
                        </select>
                        <input type="tel" class="form-control" id="deviceNumber" required placeholder="8123456789"
                          pattern="[0-9]{8,15}">
                      </div>
                      <div class="invalid-feedback">Please provide a valid phone number (8-15 digits).</div>
                      <small class="text-muted">Include number without country code or leading zero</small>
                    </div>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="submitDeviceBtn">
                      <span id="submitDeviceText">Add Device</span>
                      <span id="submitDeviceSpinner" class="spinner-border spinner-border-sm" role="status"
                        aria-hidden="true" style="display: none;"></span>
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <!-- Logs Modal -->
          <div class="modal fade" id="logsModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="logsModalTitle">Device Logs</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <div class="table-responsive">
                    <table class="table table-striped table-hover">
                      <thead>
                        <tr>
                          <th>Time</th>
                          <th>Level</th>
                          <th>Message</th>
                        </tr>
                      </thead>
                      <tbody id="logsModalBody">
                        <!-- Logs will be inserted here -->
                      </tbody>
                    </table>
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Bootstrap JS and dependencies -->
        <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>
        <!-- Font Awesome -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>

        <!-- Custom JS -->
        <script>
          // Application State
          const appState = {
            currentClientName: null,
            qrCheckInterval: null,
            statusCheckInterval: null,
            refreshInterval: null,
            clients: [],
            logs: []
          };

          // DOM Elements
          const elements = {
            addDeviceForm: document.getElementById('addDeviceForm'),
            deviceNameInput: document.getElementById('deviceName'),
            deviceNumberInput: document.getElementById('deviceNumber'),
            countryCodeSelect: document.getElementById('countryCode'),
            submitDeviceBtn: document.getElementById('submitDeviceBtn'),
            submitDeviceText: document.getElementById('submitDeviceText'),
            submitDeviceSpinner: document.getElementById('submitDeviceSpinner'),
            qrSection: document.getElementById('qrSection'),
            qrPlaceholder: document.getElementById('qrPlaceholder'),
            qrImage: document.getElementById('qrImage'),
            clientStatus: document.getElementById('clientStatus'),
            logoutBtn: document.getElementById('logoutBtn'),
            copyQrBtn: document.getElementById('copyQrBtn'),
            clientsTableBody: document.getElementById('clientsTableBody'),
            onlineDevicesCount: document.getElementById('online-devices-count'),
            totalDevicesCount: document.getElementById('total-devices-count'),
            recentActivity: document.getElementById('recent-activity'),
            recentLogsBody: document.getElementById('recentLogsBody'),
            refreshClientsBtn: document.getElementById('refreshClientsBtn'),
            currentClientNameElement: document.getElementById('currentClientName'),
            logsModal: new bootstrap.Modal('#logsModal'),
            logsModalTitle: document.getElementById('logsModalTitle'),
            logsModalBody: document.getElementById('logsModalBody')
          };

          // Initialize the application
          document.addEventListener('DOMContentLoaded', () => {
            setupFormValidation();
            setupEventListeners();
            fetchInitialData();

            // Set up auto-refresh every 10 seconds
            appState.refreshInterval = setInterval(fetchInitialData, 10000);
          });

          // Set up form validation
          function setupFormValidation() {
            elements.addDeviceForm.addEventListener('submit', async (e) => {
              e.preventDefault();
              e.stopPropagation();

              if (!elements.addDeviceForm.checkValidity()) {
                elements.addDeviceForm.classList.add('was-validated');
                return;
              }

              await handleAddDevice();
            });

            // Clear validation on input
            elements.deviceNameInput.addEventListener('input', () => {
              const value = elements.deviceNameInput.value;
              // Only allow letters, numbers, and underscores, 3-30 chars
              if (/^[A-Za-z0-9_]{3,30}$/.test(value)) {
                elements.deviceNameInput.classList.remove('is-invalid');
              } else {
                elements.deviceNameInput.classList.add('is-invalid');
              }
            });

            elements.deviceNumberInput.addEventListener('input', () => {
              if (/^\d{10}$/.test(elements.deviceNumberInput.value)) {
                elements.deviceNumberInput.classList.remove('is-invalid');
              } else {
                elements.deviceNumberInput.classList.add('is-invalid');
              }
            });
          }

          // Set up event listeners
          function setupEventListeners() {
            // Refresh button
            elements.refreshClientsBtn.addEventListener('click', fetchInitialData);

            // Logout button
            elements.logoutBtn.addEventListener('click', handleLogout);

            // Copy QR button
            elements.copyQrBtn.addEventListener('click', copyQrCode);

            // Modal hidden event
            document.getElementById('addDeviceModal').addEventListener('hidden.bs.modal', () => {
              elements.addDeviceForm.reset();
              elements.addDeviceForm.classList.remove('was-validated');
            });
          }

          // Fetch initial data
          async function fetchInitialData() {
            try {
              await Promise.all([
                fetchClients(),
                fetchRecentLogs()
              ]);
              updateStats();
            } catch (error) {
              showToast(`Error loading data: ${error.message}`, 'danger');
            }
          }

          // Update stats cards
          function updateStats() {
            const connectedCount = appState.clients.filter(c => c.status === 'connected').length;
            elements.onlineDevicesCount.textContent = connectedCount;
            elements.totalDevicesCount.textContent = appState.clients.length;

            // Update recent activity
            if (appState.logs.length > 0) {
              const latestLog = appState.logs[0];
              const timeAgo = formatTimeAgo(new Date(latestLog.timestamp));
              elements.recentActivity.innerHTML = `
                      <strong>${latestLog.clientName}</strong>: ${latestLog.message}
                      <small class="d-block text-muted">${timeAgo}</small>
                  `;
            }
          }

          function formatTimeAgo(inputDate) {
            const date = typeof inputDate === 'string' ? new Date(inputDate) : inputDate;
            const seconds = Math.floor((new Date() - date) / 1000);
            if (isNaN(seconds)) return '';
            if (seconds < 5) return 'just now';
            if (seconds < 60) return `${seconds} second${seconds !== 1 ? 's' : ''} ago`;
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes} minute${minutes !== 1 ? 's' : ''} ago`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours} hour${hours !== 1 ? 's' : ''} ago`;
            const days = Math.floor(hours / 24);
            if (days < 7) return `${days} day${days !== 1 ? 's' : ''} ago`;
            const weeks = Math.floor(days / 7);
            if (weeks < 4) return `${weeks} week${weeks !== 1 ? 's' : ''} ago`;
            // Fallback to date string for longer periods
            return date.toLocaleDateString('en-IN', { year: 'numeric', month: 'short', day: 'numeric' });
          }



          // Handle add device
          async function handleAddDevice() {
            const deviceName = elements.deviceNameInput.value.trim();
            const countryCode = elements.countryCodeSelect.value;
            const phoneNumber = `${countryCode}${elements.deviceNumberInput.value.trim()}`;

            try {
              // Show loading state
              elements.submitDeviceText.textContent = 'Adding...';
              elements.submitDeviceSpinner.style.display = 'inline-block';
              elements.submitDeviceBtn.disabled = true;

              const response = await fetch('/clients', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  name: deviceName,
                  number: phoneNumber,
                }),
              });

              let data;
              try {
                data = await response.json();
              } catch (parseError) {
                throw new Error('Failed to parse server response');
              }

              if (!response.ok) {
                throw new Error(data?.error || 'Failed to add device');
              }

              showToast('Device added successfully!', 'success');

              // Close modal
              const modalInstance = bootstrap.Modal.getInstance(document.getElementById('addDeviceModal'));
              if (modalInstance) {
                modalInstance.hide();
              }

              // Clean up modal backdrop manually if needed
              const modalBackdrop = document.querySelector('.modal-backdrop');
              if (modalBackdrop) {
                modalBackdrop.remove();
              }

              //  Reset the form and validation state after success
              elements.addDeviceForm.reset();
              elements.addDeviceForm.classList.remove('was-validated');
              elements.deviceNameInput.classList.remove('is-invalid');
              elements.deviceNumberInput.classList.remove('is-invalid');

              // Refresh data
              fetchInitialData();
            } catch (error) {
              console.error('Error:', error);
              showToast(`Error: ${error.message}`, 'danger');

              // Highlight invalid fields
              if (error.message.includes('name')) {
                elements.deviceNameInput.classList.add('is-invalid');
              } else if (error.message.includes('number')) {
                elements.deviceNumberInput.classList.add('is-invalid');
              }
            } finally {
              // Reset button state
              elements.submitDeviceText.textContent = 'Add Device';
              elements.submitDeviceSpinner.style.display = 'none';
              elements.submitDeviceBtn.disabled = false;
            }
          }



          // Fetch clients
          async function fetchClients() {
            try {
              const response = await fetch('/clients');

              if (!response.ok) {
                throw new Error('Failed to fetch clients');
              }

              appState.clients = await response.json();
              renderClientsTable();
            } catch (error) {
              console.error('Error fetching clients:', error);
              showToast(`Error: ${error.message}`, 'danger');

              // Show error in table
              elements.clientsTableBody.innerHTML = `
                      <tr>
                          <td colspan="5" class="text-center text-danger py-4">
                              <i class="bi bi-exclamation-triangle me-2"></i>
                              Failed to load devices. Please try again.
                          </td>
                      </tr>
                  `;
            }
          }

          // Render clients table
          function renderClientsTable() {
            if (appState.clients.length === 0) {
              elements.clientsTableBody.innerHTML = `
                      <tr>
                          <td colspan="5" class="text-center text-muted py-4">
                              <i class="bi bi-info-circle me-2"></i>
                              No devices found. Add your first device to get started.
                          </td>
                      </tr>
                  `;
              return;
            }

            elements.clientsTableBody.innerHTML = appState.clients.map(client => `
                  <tr data-client-name="${client.name}">
                      <td>
                          <strong>${client.name}</strong>
                          ${client.name === appState.currentClientName ? '<span class="badge bg-info ms-2">Current</span>' : ''}
                      </td>
                      <td>+${client.number}</td>
                      <td>
                          <span class="badge ${getStatusBadgeClass(client.status)}">
                              ${formatStatus(client.status)}
                          </span>
                      </td>
                      <td>${client.lastActive ? formatDateTime(client.lastActive) : 'Never'}</td>
                      <td>
                          <div class="btn-group btn-group-sm action-buttons" role="group">
                              <button class="btn" onclick="handleShowQr('${client.name}')" 
                                  title="Show QR" ${client.status === 'connected' ? 'disabled' : ''}>
                                  <i class="ti ti-qrcode"></i>
                              </button>
                              <button class="btn" onclick="handleLogoutClient('${client.name}')" 
                                  title="Logout Device" ${client.status !== 'connected' ? 'disabled' : ''}>
                                  <i class="ti ti-logout"></i>
                              </button>
                              <button class="btn" onclick="handleViewLogs('${client.name}')" title="View Logs">
                                  <i class="ti ti-activity"></i>
                              </button>
                              <button class="btn" onclick="handleDeleteClient('${client.name}')" title="Delete">
                                  <i class="ti ti-trash"></i>
                              </button>
                          </div>
                      </td>
                  </tr>
              `).join('');
          }

          // Handle logout for a specific client
          async function handleLogoutClient(clientName) {
            if (!confirm(`Are you sure you want to log out ${clientName}?`)) {
              return;
            }

            try {
              // Show loading state on the button
              const row = document.querySelector(`tr[data-client-name="${clientName}"]`);
              if (row) {
                const logoutBtn = row.querySelector('button[title="Logout Device"]');
                if (logoutBtn) {
                  logoutBtn.disabled = true;
                  logoutBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
                }
              }

              const response = await fetch(`/clients/${encodeURIComponent(clientName)}/logout`, {
                method: 'POST',
              });

              if (!response.ok) {
                throw new Error('Failed to logout client');
              }

              showToast(`${clientName} logged out successfully`, 'success');

              // If this was the current client in QR section, hide it
              if (appState.currentClientName === clientName) {
                elements.qrSection.style.display = 'none';
                appState.currentClientName = null;
              }

              // Refresh the table
              fetchInitialData();
            } catch (error) {
              console.error('Error logging out client:', error);
              showToast(`Error logging out ${clientName}: ${error.message}`, 'danger');

              // Reset button state if error occurs
              const row = document.querySelector(`tr[data-client-name="${clientName}"]`);
              if (row) {
                const logoutBtn = row.querySelector('button[title="Logout Device"]');
                if (logoutBtn) {
                  logoutBtn.disabled = false;
                  logoutBtn.innerHTML = '<i class="fas fa-right-from-bracket"></i>';
                }
              }
            }
          }

          // Get status badge class
          function getStatusBadgeClass(status) {
            switch (status) {
              case 'connected': return 'bg-success';
              case 'qr_received': return 'bg-warning';
              case 'error': return 'bg-danger';
              default: return 'bg-secondary';
            }
          }

          // Format status for display
          function formatStatus(status) {
            return status.charAt(0).toUpperCase() + status.slice(1).replace('_', ' ');
          }

          // Format date/time
          function formatDateTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString();
          }

          // Initialize client session
          async function initializeClientSession(clientName) {
            try {
              // Show QR section
              elements.qrSection.style.display = 'block';
              elements.qrPlaceholder.style.display = 'flex';
              elements.qrImage.style.display = 'none';
              elements.clientStatus.innerHTML = `
                      <div class="alert alert-info mb-0">
                          <i class="bi bi-info-circle me-2"></i> Preparing QR code for authentication...
                      </div>
                  `;
              elements.logoutBtn.style.display = 'none';
              elements.copyQrBtn.style.display = 'none';

              // Initialize client
              const response = await fetch(`/clients/initialize/${encodeURIComponent(clientName)}`, {
                method: 'POST'
              });

              if (!response.ok) {
                throw new Error('Failed to initialize client');
              }

              // Start checking for QR code and status
              checkQRCode(clientName);
              checkClientStatus(clientName);
            } catch (error) {
              console.error('Error initializing client:', error);
              showToast(`Error: ${error.message}`, 'danger');

              elements.clientStatus.innerHTML = `
                      <div class="alert alert-danger mb-0">
                          <i class="bi bi-exclamation-triangle me-2"></i> Failed to initialize device
                      </div>
                  `;
            }
          }

          // Check for QR code
          async function checkQRCode(clientName) {
            // Clear any existing interval
            if (appState.qrCheckInterval) clearInterval(appState.qrCheckInterval);

            appState.qrCheckInterval = setInterval(async () => {
              try {
                const response = await fetch(`/clients/${encodeURIComponent(clientName)}/qr`);

                if (response.ok) {
                  const data = await response.json();
                  if (data.qrCode) {
                    // Display QR code
                    elements.qrImage.src = data.qrCode;
                    elements.qrImage.style.display = 'block';
                    elements.qrPlaceholder.style.display = 'none';
                    elements.copyQrBtn.style.display = 'block';

                    // Update status
                    elements.clientStatus.innerHTML = `
                                    <div class="alert alert-warning mb-0">
                                        <i class="bi bi-exclamation-triangle me-2"></i> 
                                        Scan this QR code with WhatsApp on your phone
                                    </div>
                                `;

                    // Clear the interval since we have the QR code
                    clearInterval(appState.qrCheckInterval);
                  }
                }
              } catch (error) {
                console.error('Error checking QR code:', error);
                clearInterval(appState.qrCheckInterval);
              }
            }, 1000);
          }

          // Check client status
          async function checkClientStatus(clientName) {
            // Clear any existing interval
            if (appState.statusCheckInterval) clearInterval(appState.statusCheckInterval);

            appState.statusCheckInterval = setInterval(async () => {
              try {
                const response = await fetch(`/clients/${encodeURIComponent(clientName)}/status`);

                if (response.ok) {
                  const data = await response.json();

                  if (data.connected) {
                    // Client is connected
                    elements.clientStatus.innerHTML = `
                                    <div class="alert alert-success mb-0">
                                        <i class="bi bi-check-circle me-2"></i> 
                                        Device connected successfully!
                                    </div>
                                `;
                    elements.logoutBtn.style.display = 'block';

                    // Clear intervals and refresh data
                    clearInterval(appState.statusCheckInterval);
                    fetchInitialData();
                    showToast('Device connected successfully!', 'success');
                  } else if (data.status === 'error') {
                    // Error occurred
                    elements.clientStatus.innerHTML = `
                                    <div class="alert alert-danger mb-0">
                                        <i class="bi bi-exclamation-triangle me-2"></i> 
                                        Error connecting device
                                    </div>
                                `;
                    clearInterval(appState.statusCheckInterval);
                  }
                }
              } catch (error) {
                console.error('Error checking status:', error);
                clearInterval(appState.statusCheckInterval);
              }
            }, 2000);
          }

          // Handle logout
          async function handleLogout() {
            if (!appState.currentClientName) {
              showToast('No client selected for logout', 'warning');
              return;
            }

            if (!confirm(`Are you sure you want to log out ${appState.currentClientName}?`)) {
              return;
            }

            try {
              // Disable the logout button and show a loading indicator
              const logoutButton = document.getElementById('logoutBtn');
              logoutButton.disabled = true;

              const response = await fetch(`/clients/${encodeURIComponent(appState.currentClientName)}/logout`, {
                method: 'POST',
              });

              if (!response.ok) {
                if (response.status === 404) {
                  throw new Error('Client not found');
                } else if (response.status === 500) {
                  throw new Error('Server error occurred');
                } else {
                  throw new Error('Failed to logout');
                }
              }

              // Reset state
              elements.qrSection.style.display = 'none';
              appState.currentClientName = null;

              // Refresh data
              fetchInitialData();
              showToast('Device logged out successfully', 'success');
            } catch (error) {
              console.error('Error logging out:', error);
              showToast(`Error: ${error.message}`, 'danger');
            } finally {
              // Re-enable the logout button
              const logoutButton = document.getElementById('logoutBtn');
              logoutButton.disabled = false;
            }
          }

          // Copy QR code
          async function copyQrCode() {
            try {
              const response = await fetch(elements.qrImage.src);
              const blob = await response.blob();
              await navigator.clipboard.write([
                new ClipboardItem({ 'image/png': blob })
              ]);
              showToast('QR code copied to clipboard!', 'success');
            } catch (error) {
              console.error('Error copying QR code:', error);
              showToast('Failed to copy QR code', 'danger');
            }
          }

          // Fetch recent logs
          async function fetchRecentLogs() {
            try {
              const response = await fetch('/logs/recent');

              if (!response.ok) {
                throw new Error('Failed to fetch logs');
              }

              appState.logs = await response.json();
              renderRecentLogs();
            } catch (error) {
              console.error('Error fetching logs:', error);
              elements.recentLogsBody.innerHTML = `
                      <tr>
                          <td class="text-center text-danger py-2">
                              <i class="bi bi-exclamation-triangle me-2"></i>
                              Failed to load activity logs
                          </td>
                      </tr>
                  `;
            }
          }

          // Render recent logs
          function renderRecentLogs() {
            if (appState.logs.length === 0) {
              elements.recentLogsBody.innerHTML = `
                      <tr>
                          <td class="text-center text-muted py-2">
                              No recent activity
                          </td>
                      </tr>
                  `;
              return;
            }

            // Show only the 5 most recent logs
            const recentLogs = appState.logs.slice(0, 5);
            elements.recentLogsBody.innerHTML = recentLogs.map(log => `
    <tr>
        <td class="py-2">
            <div class="d-flex justify-content-between">
                <div>
                    <span class="badge ${getLogLevelBadgeClass(log.level)} me-2">
                        ${log.level.toUpperCase()}
                    </span>
                    <strong>${log.clientName}</strong>: ${log.message}
                </div>
                <small class="text-muted">${log.backendTime || log.timestamp}</small>
            </div>
        </td>
    </tr>
`).join('');

          }

          // Get log level badge class
          function getLogLevelBadgeClass(level) {
            switch (level) {
              case 'error': return 'bg-danger';
              case 'warn': return 'bg-warning';
              case 'info': return 'bg-info';
              default: return 'bg-secondary';
            }
          }

          // Handle view logs
          async function handleViewLogs(clientName) {
            try {
              const client = appState.clients.find(c => c.name === clientName);
              if (!client) return;

              elements.logsModalTitle.textContent = `Logs for ${client.name}`;
              elements.logsModalBody.innerHTML = `
                      <tr>
                          <td colspan="3" class="text-center py-4">
                              <div class="spinner-border text-primary" role="status">
                                  <span class="visually-hidden">Loading...</span>
                              </div>
                          </td>
                      </tr>
                  `;

              elements.logsModal.show();

              const response = await fetch(`/clients/${encodeURIComponent(clientName)}/logs`);

              if (!response.ok) {
                throw new Error('Failed to fetch logs');
              }

              const logs = await response.json();

              elements.logsModalBody.innerHTML = logs.length > 0 ?
                logs.map(log => `
                          <tr>
                              <td>${formatDateTime(log.timestamp)}</td>
                              <td>
                                  <span class="badge ${getLogLevelBadgeClass(log.level)}">
                                      ${log.level.toUpperCase()}
                                  </span>
                              </td>
                              <td>${log.message}</td>
                          </tr>
                      `).join('') : `
                          <tr>
                              <td colspan="3" class="text-center text-muted py-4">
                                  No logs found for this device
                              </td>
                          </tr>
                      `;
            } catch (error) {
              console.error('Error viewing logs:', error);
              elements.logsModalBody.innerHTML = `
                      <tr>
                          <td colspan="3" class="text-center text-danger py-4">
                              <i class="bi bi-exclamation-triangle me-2"></i>
                              Failed to load logs
                          </td>
                      </tr>
                  `;
            }
          }

          // Handle delete client
          async function handleDeleteClient(clientName) {
            const client = appState.clients.find(c => c.name === clientName);
            if (!client) return;

            if (!confirm(`Are you sure you want to delete "${client.name}"?\nThis will remove all associated data.`)) {
              return;
            }

            try {
              const logoutResponse = await fetch(`/clients/${encodeURIComponent(appState.currentClientName)}/logout`, {
                method: 'POST'
              });
              const deleteResponse = await fetch(`/clients/${encodeURIComponent(clientName)}`, {
                method: 'DELETE'
              });

              showToast('Device deleted successfully!', 'success');

              // If we're deleting the current client, hide QR section
              if (appState.currentClientName === clientName) {
                elements.qrSection.style.display = 'none';
                appState.currentClientName = null;
              }

              // Refresh data
              fetchInitialData();
            } catch (error) {
              console.error('Error deleting client:', error);
              showToast(`Error: ${error.message}`, 'danger');
            }
          }
          // When fetching clients or adding a new client
          appState.clients.forEach(c => {
            if (c.initialized === undefined) c.initialized = false;
          });

          function handleShowQr(clientName) {
            const client = appState.clients.find(c => c.name === clientName);
            if (!client) return;

            appState.currentClientName = clientName;
            elements.currentClientNameElement.textContent = client.name;

            // Only initialize if not already initialized
            if (!client.initialized) {
              initializeClientSession(clientName);
              client.initialized = true; // mark as initialized
            } else {
              // Client already initialized: just show the QR section if hidden
              elements.qrSection.style.display = 'block';
            }
          }


          // Show toast notification
          function showToast(message, type = 'info') {
            const toastContainer = document.createElement('div');
            toastContainer.className = 'position-fixed bottom-0 end-0 p-3 toast-container';
            toastContainer.style.zIndex = '1100';

            const toast = document.createElement('div');
            toast.className = `toast show align-items-center text-white bg-${type} border-0`;
            toast.role = 'alert';
            toast.ariaLive = 'assertive';
            toast.ariaAtomic = 'true';

            toast.innerHTML = `
                  <div class="d-flex">
                      <div class="toast-body">
                          <i class="bi ${type === 'success' ? 'bi-check-circle' :
                type === 'danger' ? 'bi-exclamation-triangle' :
                  'bi-info-circle'} me-2"></i>
                          ${message}
                      </div>
                      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                  </div>
              `;

            toastContainer.appendChild(toast);
            document.body.appendChild(toastContainer);

            // Auto remove after 5 seconds
            setTimeout(() => {
              toast.classList.remove('show');
              setTimeout(() => {
                toastContainer.remove();
              }, 300);
            }, 5000);
          }

          // Make functions available globally for inline handlers
          window.handleShowQr = handleShowQr;
          window.handleLogoutClient = handleLogoutClient;
          window.handleViewLogs = handleViewLogs;
          window.handleDeleteClient = handleDeleteClient;
        </script>

        <!-- Footer -->
        <footer class="content-footer footer bg-footer-theme">
          <div class="container-xxl">
            <div
              class="footer-container d-flex align-items-center justify-content-between py-4 flex-md-row flex-column">
              <div class="text-body">
                ©
                <script>
                  document.write(new Date().getFullYear());
                </script>
                , made with ❤️ by <a href="https://github.com/abhinavelaveni" target="_blank">abhinavelaveni</a>
              </div>
              <div class="d-none d-lg-inline-block">
                <a href="https://demos.themeselection.com/sneat-bootstrap-html-admin-template/documentation/"
                  target="_blank" class="footer-link me-4">Documentation</a>

                <a href="https://github.com/themeselection/sneat-html-admin-template-free/issues" target="_blank"
                  class="footer-link">Support</a>
              </div>
            </div>
          </div>
        </footer>
        <!-- / Footer -->

        <div class="content-backdrop fade"></div>
      </div>
      <!-- Content wrapper -->
    </div>
    <!-- / Layout page -->
  </div>

  <!-- Overlay -->
  <div class="layout-overlay layout-menu-toggle"></div>
  </div>

  <!-- Core JS -->
  <!-- build:js assets/vendor/js/core.js -->

  <script src="../assets/vendor/libs/jquery/jquery.js"></script>
  <script src="../assets/vendor/libs/popper/popper.js"></script>
  <script src="../assets/vendor/js/bootstrap.js"></script>
  <script src="../assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.js"></script>
  <script src="../assets/vendor/js/menu.js"></script>

  <!-- endbuild -->

  <!-- Vendors JS -->
  <script src="../assets/vendor/libs/apex-charts/apexcharts.js"></script>

  <!-- Main JS -->
  <script src="../assets/js/main.js"></script>

  <!-- Page JS -->
  <script src="../assets/js/dashboards-analytics.js"></script>

  <!-- Place this tag before closing body tag for github widget button. -->
  <script async defer src="https://buttons.github.io/buttons.js"></script>
</body>

</html>